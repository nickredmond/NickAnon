<html>
  <head>
    <title>NickAnon</title>
  </head>
  <body>
    <h3 id="page-heading">Good Energeez, Inc.</h3>
    <p class="title">Enjoy &#128522;</p>
    
    <div id="main-menu">
      <button type="button" onclick="setCurrentView('question-form', 'Recovery AI')">Recovery AI</button>
      <button type="button" onclick="setCurrentView('warm-wordz', 'Warm Wordz')">Warm Wordz</button>
      <button type="button" onclick="setCurrentView('gnn-feed', 'Good News')">Good News</button>
      <button type="button" onclick="setCurrentView('discussion-board', 'Discussion')">Discussion</button>
    </div>
    
    <div id="section-heading">
      <button id="btn-back" type="button" onclick="goBack()">
        &#9001;<span>Back</span>
      </button>
      <h3 id="section-title"></h3>
    </div>
    
    <div id="question-form">
      <div id="question-validation-error">
        Provide a question and select role.
      </div>
      <div>
        <label for="question-input">Ask a recovery-related question:</label>
        <textarea id="question-input" rows="3"></textarea>
      </div>
      <div>
        <label>AI answers the question as a:</label>
        <div>
          <div>
            <button type="button" class="answer-as" onclick="answerAs(this, 'researcher')">researcher</button>
            <button type="button" class="answer-as" onclick="answerAs(this, 'therapist')">therapist</button>
          </div>
          <div>
            <button type="button" class="answer-as" onclick="answerAs(this, 'mother')">mother</button>
            <button type="button" class="answer-as" onclick="answerAs(this, 'friend')">friend</button>
          </div>
        </div>
      </div>
      <div>
        <button id="btn-submit-question" class="btn btn-submit" type="button" onclick="submitQuestion()">Ask</button>
        <button class="btn btn-secondary" type="button" onclick="clearAiQuestion()">Reset</button>
      </div>
      <p id="ai-disclaimer"><strong>DISCLAIMER:&nbsp;</strong>This feature of artificial intelligence (AI) is available to encourage thought-provoking discussion and constructive self-reflection. That said, the AI is not a trained professional and isn't intended to be used for therapeutic or scientific purposes. Please use caution.</p>
    </div>
    
    <div id="warm-wordz">
      <div class="feed">
      <p></p>
    </div>
    <div class="feed">
      <p></p>
    </div>
    <div class="feed">
      <p></p>
    </div>
      <div id="content-refresh-banner">
        Content will be updated in <span id="minutes-counter"></span>.
      </div>
    </div>
    
    <div id="gnn-feed">
      <div class="gnn">
      <h5></h5>
      <h6></h6>
      <p></p>
      <a>Read more</a>
    </div>
    <div class="gnn">
      <h5></h5>
      <h6></h6>
      <p></p>
      <a>Read more</a>
    </div>
    <div class="gnn">
      <h5></h5>
      <h6></h6>
      <p></p>
      <a>Read more</a>
    </div>
    </div>
    
    <dialog id="answer-dialog">
      <p id="answer-dialog-title"><strong>ANSWER:</strong></p>
      <p id="answer-text"></p>
      <form method="dialog">
        <button id="dialog-okay" class="btn btn-submit" onclick="dialogClosed()">OK</button>
      </form>
    </dialog>
    <div id="dialog-overlay">
    </div>
    
    <div id="footer">
      <p><strong>Powered by <a href="https://www.goodnewsnetwork.org/">Good News Network</a> and <a href="https://gemini.google.com/">Gemini AI</a> and lots of love.</strong></p>
      <p><strong>Note:&nbsp;</strong>Good News articles are updated at least daily.</p>
      <p><strong>What's this about?&nbsp;</strong>Good Energeez is meant to be a place that offers uplifting spirit for people when they feel drained and need a quick boost. This site is especially geared toward those who are recovering from addiction &#9829;</p>
    </div>
    
    <style>
      body {
        font-family: Sans-Serif;
      }
    
      .feed, .gnn {
        margin: 2vw;
        padding: 2vw;
      }
      
      .feed {
        font-size: 6vw;
      }
      
      .gnn {
        font-size: 4vw;
      }
      .gnn h5 {
        font-size: 6vw;
        margin: 2vw 0;
      }
      .gnn h6 {
        margin: 0;
      }
      
      .title {
        font-size: 4vw;
        text-align: center;
        padding-top: 2vw;
      }
      
      #footer {
        font-size: 4vw;
        padding-left: 2vw;
        margin-top: 3vw;
        border-top: 0.5vw solid #ddd;
      }
      
      #page-heading {
        text-align: center;
        font-size: 5vw;
        padding-top: 2vw;
      }
      
      #question-form {
        margin-top: 2vw;
        padding: 2vw;
      }
      
      #question-form label {
        font-size: 3vw;
        font-weight: bold;
      }
      
      #question-form textarea {
        width: 90vw;
        font-size: 3vw;
        height: 20vw;
        border: 0.25vw solid #ddd;
        border-radius: 0.1vw;
      }
      
      .answer-as {
        width: 40vw;
        font-size: 6vw;
        padding: 2vw;
        border: 0.25vw solid #ccc;
        border-radius: 1vw;
        background-color: #fff;
        margin: 2vw 0 0 2vw;
      }
      
      #btn-submit-question {
        margin-top: 2vw;
        font-size: 5vw;
      }
      
      #question-validation-error {
        display: none;
        font-size: 4vw;
        color: #cc3333;
        padding-bottom: 2vw;
      }
      
      #answer-dialog {
        z-index: 20;
        top: 10vh;
        width: 80vw;
        padding-left: 4vw;
      }
      
      #answer-dialog-title {
        margin-top: 2vw;
      }
      
      #answer-dialog p {
        font-size: 5vw;
      }
      
      .btn {
        font-size: 5vw;
        padding: 2vw;
        font-weight: bold;
        margin-right: 2vw;
      }
      
      .btn-submit {
        background-color: #000088;
        color: #fff;
        border: 1px solid #000055;
      }
      
      .btn-secondary {
        background-color: #dedede;
        color: #222;
        border: 1px solid #888;
      }
      
      #dialog-overlay {
        display: none;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 10;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 300vh;
      }
      
      #section-heading {
        background-color: #777;
        padding: 3vw;
        display: none;
      }
      
      #section-title {
        font-size: 7vw;
        color: #efefef;
        text-align: center;
        margin: 0;
      }
      
      #btn-back {
        font-size: 5vw;
        font-weight: bold;
        color: #efefef;
        background-color: transparent;
        border: none;
        position: absolute;
        left: 2vw;
      }
      
      #btn-back span {
        text-decoration: underline;
        padding-left: 2vw;
      }
      
      #question-form,
      #warm-wordz,
      #gnn-feed,
      #discussion-board {
        display: none;
      }
      
      #main-menu {
        text-align: center;
      }
     
      #main-menu button {
        background-color: #000077;
        color: white;
        font-size: 8vw;
        margin-top: 3vw;
        padding: 3vw;
        width: 60vw;
      }
      
      #ai-disclaimer {
        margin-top: 3vw;
      }
      
      #ai-disclaimer strong {
        text-decoration: underline;
      }
      
      #content-refresh-banner {
        padding: 2vw;
        margin-top: 2vw;
        font-size: 4vw;
        background-color: #FFFF33;
      }
    </style>
    
    <script>
      let currentViewId;
      function goBack() {
        document.getElementById(currentViewId).style.display = 'none'
        document.getElementById('section-heading').style.display = 'none'
        document.getElementById('main-menu').style.display = 'block'
        document.getElementById('question-input').value = ''
      }
      
      function setCurrentView(id, title) {
        currentViewId = id
        document.getElementById('main-menu').style.display = 'none'
        document.getElementById(currentViewId).style.display = 'block'
        document.getElementById('section-heading').style.display = 'block'
        document.getElementById('section-title').textContent = title
      }
      
      function clearAiQuestion() {
        document.getElementById('question-input').value = ''
        answerAs(null, null)
      }
      
      const pastelColors = [
        '#FFbbee',
        '#99FFFF',
        '#CC99FF',
        '#dfFFdf',
        '#aaFF99',
    //    '#FFccaa',
        '#FFFFbb',
        '#CCCCFF',
        '#Faa9a9',
        '#CCFFaa'
      ]
      let colorIndex = 0
      
      async function fetchData(name, onDatum) {
        const response = await fetch('/' + name)
        const data = await response.json()
        if (data.length > 0) {
          const elements = [...document.querySelectorAll('.' + name)]
          elements.forEach((elmt, i) => {
            elmt.style.backgroundColor = pastelColors[colorIndex]
            colorIndex++
            onDatum(elmt, data[i])
          })
        } else {
          alert('Server is busy generating good stuff for you. Try again in a minute.')
        }
      }
      
      function getFeedResults() {
        fetchData('feed', (element, result) => {
          element.querySelector('p').textContent = result
        })
      }
      
      function getGoodNews() {
        fetchData('gnn', (element, article) => {
          const title = element.querySelector('h5')
          title.textContent = article.title
          const date = element.querySelector('h6') 
          const when = article.pubDate.split(' ')
          const pubDate = `(${when[0]} ${when[1]} ${when[2]} ${when[3]})`
          date.textContent = pubDate
          const link = element.querySelector('a')
          link.href = article.link
          const summary = element.querySelector('p')
          const descHalf = article.description.split('</p>')[0]
          summary.innerHTML = descHalf.split('<p>')[1]
        })
      }
      
      let role;
      function answerAs(target, pickedRole) {
        role = pickedRole
        const buttons = [...document.querySelectorAll('.answer-as')]
        for (let button of buttons) {
          if (button === target) {
            button.style.backgroundColor = '#ddd'
            button.style.border = '0.5vw solid #bbb'
          } else {
            button.style.backgroundColor = '#fff'
            button.style.border = '1px solid #ddd'
          }
        }
      }
      
      function dialogClosed() {
        document.getElementById('dialog-overlay').style.display = 'none'
      }
      
      let submitInterval;
      function submitQuestion() {
        const input = document.getElementById('question-input')
        const question = input.value
        const validation = document.getElementById('question-validation-error')
        if (question && role) {
          validation.style.display = 'none'
          const button = document.getElementById('btn-submit-question')
          button.setAttribute('disabled', true)
          button.textContent = 'Please wait...'
          input.setAttribute('disabled', true)
          input.style.fontWeight = 'bold'
          input.value = 'Generating answer...'
          submitInterval = setInterval(function() {
            if (input.value === 'Generating answer...') {
              input.value = 'Generating answer.'
            } else {
              input.value += '.'
            }
          }, 250)
          fetch('/question', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question, role })
          })
          .then(res => res.json())
          .then(data => {
            clearInterval(submitInterval)
            document.getElementById('dialog-overlay').style.display = 'block'
            input.style.fontWeight = 'normal'
            input.value = question
            input.removeAttribute('disabled')
            button.textContent = 'Ask'
            button.removeAttribute('disabled')
            const answerText = document.getElementById('answer-text')
            answerText.textContent = data.answer
            document.getElementById('answer-dialog').setAttribute('open', true)
          })
        } else {
          validation.style.display = 'block'
        }
      }
      
      let refreshMinutes;
      document.addEventListener("DOMContentLoaded", _ => {
        getFeedResults()
        getGoodNews()
        
        refreshMinutes = 5
        const minutesSpan = document.getElementById('minutes-counter')
        minutesSpan.textContent = refreshMinutes + ' minutes'
        setInterval(function() {
          refreshMinutes--
          if (refreshMinutes < 0) {
            getFeedResults()
            refreshMinutes = 5
            minutesSpan.textContent = '5 minutes'
          } else if (refreshMinutes === 0) {
            minutesSpan.textContent = 'less than 1 minute'
          } else if (refreshMinutes === 1) {
            minutesSpan.textContent = '1 minute'
          } else {
            minutesSpan.textContent = refreshMinutes + ' minutes'
          }
        }, 60000)
      })
    </script>
  </body>
</html>